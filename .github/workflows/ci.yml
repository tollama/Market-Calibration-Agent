name: CI

on:
  pull_request:
  push:
    branches: [main]
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  hardening-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if ! command -v uv >/dev/null 2>&1; then
            python -m pip install uv
          fi
          uv pip sync requirements.lock
          pip install -e ".[dev]"

      - name: Verify requirements lockfile sync
        run: |
          uv pip compile pyproject.toml --all-extras -o /tmp/requirements.lock.expected
          python - <<'PY'
          import pathlib

          def normalize(path: str) -> list[str]:
              lines = pathlib.Path(path).read_text(encoding="utf-8").splitlines()
              return [line.strip() for line in lines if line.strip() and not line.startswith("#")]

          committed = normalize("requirements.lock")
          compiled = normalize("/tmp/requirements.lock.expected")
          if committed != compiled:
              print("requirements.lock is out of sync with pyproject.toml")
              import difflib

              for line in difflib.unified_diff(
                  committed,
                  compiled,
                  fromfile="requirements.lock",
                  tofile="requirements.lock (compiled)",
                  lineterm="",
              ):
                  print(line)
              raise SystemExit(1)
          PY

      - name: Run OpenAPI hardening smoke against local API
        run: |
          set -euo pipefail
          API_BASE="http://127.0.0.1:8100"

          PYTHONPATH=. python3 -m uvicorn api.app:app --host 127.0.0.1 --port 8100 > /tmp/openapi-uvicorn.log 2>&1 &
          API_PID=$!
          trap 'kill "$API_PID" >/dev/null 2>&1 || true' EXIT

          readiness=0
          for i in $(seq 1 30); do
            if curl -fsS "${API_BASE}/openapi.json" >/dev/null; then
              readiness=1
              break
            fi
            if ! kill -0 "$API_PID" >/dev/null 2>&1; then
              printf 'API process exited before startup.\n--- logs ---\n' >&2
              cat /tmp/openapi-uvicorn.log >&2 || true
              exit 1
            fi
            sleep 1
          done

          if [[ "$readiness" -ne 1 ]]; then
            printf 'API readiness check timed out.\n--- logs ---\n' >&2
            cat /tmp/openapi-uvicorn.log >&2 || true
            exit 1
          fi

          python3 scripts/openapi_smoke.py --base-url "${API_BASE}"

      - name: Run hardening smoke/auth/security checks
        run: |
          python -m pytest -q \
            tests/unit/test_tsfm_perf_smoke.py \
            tests/unit/test_api_tsfm_auth.py \
            tests/unit/test_api_tsfm_rate_limit.py

  unit-tests:
    needs: hardening-gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if ! command -v uv >/dev/null 2>&1; then
            python -m pip install uv
          fi
          uv pip sync requirements.lock
          pip install -e ".[dev]"

      - name: Run unit tests
        run: python -m pytest -q tests/unit

      - name: Run PRD1 acceptance gate selection
        run: |
          python -m pytest -q \
            tests/unit/test_i01_acceptance.py \
            tests/unit/test_i15_acceptance.py \
            tests/unit/test_i20_acceptance.py

  prd2-release-gate:
    needs: unit-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if ! command -v uv >/dev/null 2>&1; then
            python -m pip install uv
          fi
          uv pip sync requirements.lock
          pip install -e ".[dev]"

      - name: Run PRD2 one-command gate
        run: PRD2_VERIFY_PYTHON_BIN=python3.11 scripts/prd2_verify_all.sh

      - name: Upload PRD2 gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prd2-verify-all-artifacts
          path: |
            artifacts/prd2_verify_summary.json
            artifacts/prd2_release_audit_report.json
            artifacts/prd2_verify_logs/

  live-tollama-integration:
    needs: [unit-tests, prd2-release-gate]
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'schedule' || vars.ENABLE_LIVE_TOLLAMA_CI == 'true') && secrets.TOLLAMA_BASE_URL != '' }}
    env:
      LIVE_TOLLAMA_TESTS: "1"
      TOLLAMA_BASE_URL: ${{ secrets.TOLLAMA_BASE_URL }}
      TOLLAMA_TOKEN: ${{ secrets.TOLLAMA_TOKEN }}
      TOLLAMA_ENDPOINT: ${{ vars.TOLLAMA_ENDPOINT }}
      TOLLAMA_MODEL_NAME: ${{ vars.TOLLAMA_MODEL_NAME }}
      TOLLAMA_MODEL_VERSION: ${{ vars.TOLLAMA_MODEL_VERSION }}
      TOLLAMA_TIMEOUT_S: "8"
      TOLLAMA_RETRY_COUNT: "0"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if ! command -v uv >/dev/null 2>&1; then
            python -m pip install uv
          fi
          uv pip sync requirements.lock
          pip install -e ".[dev]"

      - name: Run live tollama integration tests
        run: python -m pytest -q tests/integration/test_tollama_live_integration.py
